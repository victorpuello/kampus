<header class="header">
  <div class="header-left">
    <span class="logo">
      {% if institution and institution.pdf_show_logo and institution.logo %}
        <img src="{{ institution.logo.url }}" alt="Logo" />
      {% else %}
        IE
      {% endif %}
    </span>
    <div class="inst">
      <p class="inst-name">{{ institution.name|default:"Institución Educativa" }}</p>
      {% if institution.pdf_header_line2 %}
        <p class="inst-line">{{ institution.pdf_header_line2 }}</p>
      {% endif %}
      <div class="inst-meta">
        {% if institution.dane_code %}<span>DANE: {{ institution.dane_code }}</span>{% endif %}
        {% if institution.nit %}<span>NIT: {{ institution.nit }}</span>{% endif %}
      </div>
    </div>
  </div>
  <div class="header-right">
    <div class="period-kicker">Periodo</div>
    <div class="period-number">
      {% if period_name %}{% if period_name|length == 1 %}0{{ period_name }}{% else %}{{ period_name }}{% endif %}{% else %}--{% endif %}
    </div>
    <div class="period-year">Año Lectivo {{ year_name|default:"" }}</div>
  </div>
</header>

<section class="student-card avoid-break">
  <div class="row">
    <div class="col" style="width: 50%; padding-right: 8px;">
      <div class="k">Estudiante</div>
      <div class="v-lg">{{ student_name|default:"-" }}</div>
      {% if student_code %}
        <div class="k" style="margin-top: 8px;">Documento</div>
        <div class="v">{{ student_code }}</div>
      {% endif %}
    </div>

    <div class="col" style="width: 16%; padding-right: 8px;">
      <div class="k">Grado / Grupo</div>
      <div class="v">{{ group_name|default:"-" }}</div>
    </div>

    <div class="col" style="width: 16%; padding-right: 8px;">
      <div class="k">Jornada</div>
      <div class="v">{{ shift_name|default:"-" }}</div>
    </div>

    <div class="col" style="width: 18%; text-align: right;">
      <div class="k">Fecha</div>
      <div class="v"><span class="pill" style="max-width: 100%;">{{ report_date|default:"" }}</span></div>
    </div>
  </div>

  <div class="divider">
    <span class="k">Director de Grupo:</span>
    <span class="v" style="display:inline; font-size: 11px; font-weight: 800; color:#374151;"> {{ director_name|default:"-" }}</span>
  </div>
</section>

<table class="grades">
  <thead>
    <tr>
      <th class="subject" style="width: 44%;">Área / Asignatura</th>
      <th style="width: 8%;">Faltas</th>
      <th style="width: 8%;">P1</th>
      <th style="width: 8%;">P2</th>
      <th style="width: 8%;">P3</th>
      <th style="width: 8%;">P4</th>
      <th style="width: 16%; background:#f3f4f6; color:#111827;">Final</th>
    </tr>
  </thead>
  <tbody>
    {% for row in rows %}
      {% if row.row_type == 'AREA' %}
        <tr class="avoid-break area-row">
          <td class="subject">
            <div class="area-title">{{ row.title|default:"" }}</div>
          </td>
          <td class="grade-cell muted">-</td>
          <td class="grade-cell">
            <span
              class="{% if 'superior' in row.p1_scale|lower %}perf-superior{% elif 'alto' in row.p1_scale|lower %}perf-alto{% elif 'basi' in row.p1_scale|lower %}perf-basico{% elif 'bajo' in row.p1_scale|lower %}perf-bajo{% endif %}"
            >{{ row.p1_score|default:"" }}</span>
          </td>
          <td class="grade-cell">
            <span
              class="{% if 'superior' in row.p2_scale|lower %}perf-superior{% elif 'alto' in row.p2_scale|lower %}perf-alto{% elif 'basi' in row.p2_scale|lower %}perf-basico{% elif 'bajo' in row.p2_scale|lower %}perf-bajo{% endif %}"
            >{{ row.p2_score|default:"" }}</span>
          </td>
          <td class="grade-cell">
            <span
              class="{% if 'superior' in row.p3_scale|lower %}perf-superior{% elif 'alto' in row.p3_scale|lower %}perf-alto{% elif 'basi' in row.p3_scale|lower %}perf-basico{% elif 'bajo' in row.p3_scale|lower %}perf-bajo{% endif %}"
            >{{ row.p3_score|default:"" }}</span>
          </td>
          <td class="grade-cell">
            <span
              class="{% if 'superior' in row.p4_scale|lower %}perf-superior{% elif 'alto' in row.p4_scale|lower %}perf-alto{% elif 'basi' in row.p4_scale|lower %}perf-basico{% elif 'bajo' in row.p4_scale|lower %}perf-bajo{% endif %}"
            >{{ row.p4_score|default:"" }}</span>
          </td>
          <td class="grade-cell grade-final">
            <span
              class="{% if 'superior' in row.final_scale|lower %}perf-superior{% elif 'alto' in row.final_scale|lower %}perf-alto{% elif 'basi' in row.final_scale|lower %}perf-basico{% elif 'bajo' in row.final_scale|lower %}perf-bajo{% endif %}"
            >{{ row.final_display|default:row.final_score }}</span>
          </td>
        </tr>
      {% else %}
      <tr class="avoid-break subject-row{% if row.is_single_area %} single-area-row{% endif %}">
        <td class="subject">
          <div class="subject-title{% if not row.is_single_area %} subject-title-indent{% endif %}">
            {% if row.is_single_area %}
              {{ row.title|default:"" }}
            {% else %}
              {{ row.title|default:""|title }}{% if row.weight_percentage %} ({{ row.weight_percentage }}%){% endif %}
            {% endif %}
          </div>
          {% if row.lines and row.lines|length > 0 %}
            <div class="subject-desc">
              {% if row.lines_as_paragraph %}
                <div>{{ row.lines|join:" " }}</div>
              {% else %}
                {% for line in row.lines %}
                  <div>• {{ line }}</div>
                {% endfor %}
              {% endif %}
            </div>
          {% endif %}
        </td>
        <td class="grade-cell muted">{% if row.absences %}{{ row.absences }}{% else %}-{% endif %}</td>

        <td class="grade-cell">
          <span
            class="{% if 'superior' in row.p1_scale|lower %}perf-superior{% elif 'alto' in row.p1_scale|lower %}perf-alto{% elif 'basi' in row.p1_scale|lower %}perf-basico{% elif 'bajo' in row.p1_scale|lower %}perf-bajo{% endif %}"
          >{{ row.p1_score|default:"" }}</span>
        </td>
        <td class="grade-cell">
          <span
            class="{% if 'superior' in row.p2_scale|lower %}perf-superior{% elif 'alto' in row.p2_scale|lower %}perf-alto{% elif 'basi' in row.p2_scale|lower %}perf-basico{% elif 'bajo' in row.p2_scale|lower %}perf-bajo{% endif %}"
          >{{ row.p2_score|default:"" }}</span>
        </td>
        <td class="grade-cell">
          <span
            class="{% if 'superior' in row.p3_scale|lower %}perf-superior{% elif 'alto' in row.p3_scale|lower %}perf-alto{% elif 'basi' in row.p3_scale|lower %}perf-basico{% elif 'bajo' in row.p3_scale|lower %}perf-bajo{% endif %}"
          >{{ row.p3_score|default:"" }}</span>
        </td>
        <td class="grade-cell">
          <span
            class="{% if 'superior' in row.p4_scale|lower %}perf-superior{% elif 'alto' in row.p4_scale|lower %}perf-alto{% elif 'basi' in row.p4_scale|lower %}perf-basico{% elif 'bajo' in row.p4_scale|lower %}perf-bajo{% endif %}"
          >{{ row.p4_score|default:"" }}</span>
        </td>

        <td class="grade-cell grade-final">
          <span
            class="{% if 'superior' in row.final_scale|lower %}perf-superior{% elif 'alto' in row.final_scale|lower %}perf-alto{% elif 'basi' in row.final_scale|lower %}perf-basico{% elif 'bajo' in row.final_scale|lower %}perf-bajo{% endif %}"
          >{{ row.final_display|default:row.final_score }}</span>
        </td>
      </tr>
      {% endif %}
    {% endfor %}
  </tbody>
</table>

<div class="footer">
  <div class="summary avoid-break">
    <div style="display: table; width: 100%; table-layout: fixed;">
      <div style="display: table-cell; width: 36%; vertical-align: top;">
        <span style="font-weight: 900; text-transform: uppercase; letter-spacing: 0.06em;">Promedio general:</span>
        {% if overall_score %}
          <span style="margin-left: 6px; font-size: 16px; font-weight: 900; color:#111827;">{{ overall_score }}</span>
          {% if overall_scale %}
            <span style="margin-left: 6px; font-weight: 900;" class="{% if 'superior' in overall_scale|lower %}perf-superior{% elif 'alto' in overall_scale|lower %}perf-alto{% elif 'basi' in overall_scale|lower %}perf-basico{% elif 'bajo' in overall_scale|lower %}perf-bajo{% endif %}">
              ({{ overall_scale }})
            </span>
          {% endif %}
        {% else %}
          <span style="margin-left: 6px;" class="muted">-</span>
        {% endif %}

        {% if rank_position and rank_total %}
          <div class="rank-row">
            <span class="rank-pill">Puesto en el grupo: {{ rank_position }} de {{ rank_total }}</span>
            {% if rank_badge_label %}
              <span class="rank-badge rank-{{ rank_position }}">Felicitaciones · {{ rank_badge_label }}</span>
            {% endif %}
          </div>
        {% endif %}
      </div>
      <div style="display: table-cell; width: 64%; vertical-align: top;">
        <span style="font-weight: 900; text-transform: uppercase; letter-spacing: 0.06em;">Escala institucional:</span>
        <span style="margin-left: 6px;">{{ scale_equivalences|default:"" }}</span>
      </div>
    </div>
  </div>

  <div class="sign-grid avoid-break">
    <div class="sign-col" style="width: 100%;">
      <div class="sign-line"></div>
      <div class="sign-name">{{ director_name|default:"" }}</div>
      <div class="sign-role">Director de grupo</div>
    </div>
  </div>

  {% if qr_image_src or verify_url %}
    <div class="qr-wrap">
      {% if qr_image_src %}
        <img src="{{ qr_image_src }}" alt="QR verificación" />
      {% endif %}
      {% if verify_url %}
        <div class="qr-text">
          <span style="font-weight:900;">Verificación:</span>
          <a class="verify-link" href="{{ verify_url }}">Abrir enlace</a>
        </div>
        {% if verify_url_prefix and verify_token %}
          <div class="qr-text verify-url">{{ verify_url_prefix }}{{ verify_token }}/</div>
          <div class="qr-text">Código: <span class="verify-token">{{ verify_token }}</span></div>
        {% else %}
          <div class="qr-text verify-url">{{ verify_url }}</div>
        {% endif %}
      {% endif %}
    </div>
  {% endif %}
</div>
